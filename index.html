<html>
    <head>
        <title>Dodge!</title>

        <script src="lib/phaser.min.js"></script>
    </head>
    <body>
        <script type="text/javascript">
            const config = {
                type: Phaser.AUTO,
                width: 480,
                height: 480,
                physics: {
                    default: 'arcade',
                    arcade: { }
                },
                scene: {
                    preload, create, update
                }
            };

            const game = new Phaser.Game(config);

            let player = null;
            let playerGroup = null;
            let gameOver = false;

            let score = 0;
            let scoreLabel = null;
            let gameOverLabel = null;

            let gameLoop = null;

            let bullets = [];
            let bulletGroup = null;

            function preload() {
                this.load.image('particle', 'assets/particle.png');
                this.load.image('particle-red', 'assets/particle-red.png');
                this.load.image('particle-yellow', 'assets/particle-yellow.png');
                this.load.image('green', 'assets/green.png');
                   
            }

            function create() {
                this.input.setDefaultCursor('none');

                scoreLabel = this.add.text(25, 25, '', { color: '#FFFFFF', fontSize: 24 }).setDepth(400);
                // gameOverLabel = this.add.text(200, 32, 'Press <Space> to start',
                //                               { 
                //                                   color: '#FFFFFF', 
                //                                   fontSize: 36, 
                //                                   align: 'center' 
                //                               }).setDepth(400);

                initGame(this);

                player = this.add.circle(0, 0, 16);
                playerGroup = this.physics.add.group();
                playerGroup.add(player);

                bulletGroup = this.physics.add.group();

                this.add.particles('particle', {

                    speed: { min: 110, max: 130 },
                    frequency: 25,
                    lifespan: 150,
                    scale: { min: 1, max: 2 },
                    angle: { min: 0, max: 360 },
                    follow: player
                });

                shoot(this);

                this.physics.add.overlap(playerGroup, 
                                         bulletGroup,
                                         function() {
                                            gameOver = true;
                                            gameLoop.paused = true;
                                         },
                                         null,
                                         this);

                this.input.keyboard.on('keydown', e => {
                
                    if (e.keyCode == Phaser.Input.Keyboard.KeyCodes.SPACE) {
                        if (gameOver) {
                            score = 0;
                            gameOver = false;
                            gameLoop.paused = false;
                            bullets.forEach(b => {
                                b.particles.destroy();
                                b.destroy();
                            });
                            bullets.length = 0;
                        }
                    }
                });
            }

            function initGame(scene) {
                score = 0;
                
                initGameLoop(scene, 250);
            }

            function initGameLoop(scene, delay) {
                if (gameLoop !== null) {
                    gameLoop.destroy();
                    gameLoop = null;
                }

                gameLoop = scene.time.addEvent({
                    delay,
                    loop: true,
                    callbackScope: scene,
                    callback: function() {
                        score++;
                        if (score > 50 || score % 2 === 1) {
                            shoot(scene);
                        }
                        if (score > 199) {
                            if (score % 50 === 0 || score % 50 === 5) {
                                specAttack(scene, 0);
                            } else if (score % 50 === 2) {
                                specAttack(scene, 1);
                            }
                        }
                    }
                });
            }

            function shoot(scene) {
                const dir = Math.round(Math.random() * 3);
                let rx;
                let ry;
                if (dir === 0) {
                    rx = 0;
                    ry = randPos();
                } else if (dir === 1) {
                    rx = randPos();
                    ry = 0;
                } else if (dir === 2) {
                    rx = 500;
                    ry = randPos();
                } else if (dir === 3) {
                    rx = randPos();
                    ry = 500;
                }
                const rect = scene.add.rectangle(rx, ry, 24, 24);
                rect.dir = dir;
                const fast = score > 100 && Math.random() <= 0.1;
                rect.speed = fast ? 20 : 8;

                bulletGroup.add(rect);

                const prt = scene.add.particles(fast ? 'particle-yellow' : 'particle-red', {

                    speed: { min: 110, max: 130 },
                    frequency: 25,
                    lifespan: 150,
                    scale: { min: 1, max: 2 },
                    angle: { min: 0, max: 360 },
                    follow: rect
                });
                rect.particles = prt;

                bullets.push(rect);
            }

            function specAttack(scene, type) {

                const rects = [];
                if (type % 2 === 0) {
                    rects.push(scene.add.rectangle(0, 0, 24, 24));
                    rects.push(scene.add.rectangle(480, 0, 24, 24));
                } else {
                    rects.push(scene.add.rectangle(480, 480, 24, 24));
                    rects.push(scene.add.rectangle(0, 480, 24, 24));
                }
                
                for (let r of rects) {
                    r.speed = 16;
                    bullets.push(r);

                    const prt = scene.add.particles('green', {
                        speed: { min: 110, max: 130 },
                        frequency: 25,
                        lifespan: 150,
                        scale: { min: 1, max: 2 },
                        angle: { min: 0, max: 360 },
                        follow: r
                    });
                    r.particles = prt;
                }
                
                if (type % 2 === 0) {
                    rects[0].dir = 10;
                    rects[1].dir = 11;
                } else {
                    rects[0].dir = 12;
                    rects[1].dir = 13;
                }
            }

            function randPos() {
                return Math.round(Math.random() * 380 + 50);
            }

            function update() {
                scoreLabel.setText([
                    score
                ]);

                if (!gameOver) {
                    const p = this.input.activePointer;
                    player.setX(p.worldX);
                    player.setY(p.worldY);
                
                    for (let rect of bullets) {
                        const speed = rect.speed;
                        if (rect.dir === 0 || rect.dir === 10 || rect.dir === 13) {
                            rect.setX(rect.x+speed);
                        } if (rect.dir === 1 || rect.dir === 10 || rect.dir === 11) {
                            rect.setY(rect.y+speed);
                        } if (rect.dir === 2 || rect.dir === 11 || rect.dir === 12) {
                            rect.setX(rect.x-speed);
                        } if (rect.dir === 3 || rect.dir === 12 || rect.dir === 13) {
                            rect.setY(rect.y-speed);
                        }
                    }
                }


                // gameOverLabel.setVisible(isGameOver);
            }
        </script>
    </body>
</html>